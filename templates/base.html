{% load i18n %}
<!doctype html>
<html lang="{{ LANGUAGE_CODE|default:'pt' }}">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% trans "Navigator UK Market Intelligence (MVP)" %}</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- i18n bootstrap: server Ã© sempre fonte de verdade -->
  <script>
    (function () {
      const serverLang = '{{ LANGUAGE_CODE|default:"pt" }}';
      const storedLang = localStorage.getItem('navigator-lang');
      if (storedLang !== serverLang) localStorage.setItem('navigator-lang', serverLang);
      window.serverLang = serverLang;
      window.currentLang = serverLang;
      document.documentElement.setAttribute('lang', serverLang);
    })();
  </script>

  <style>
    :root {
      --navigator-orange: #C6744A;
      --navigator-orange-light: #FF8A65;
      --navigator-orange-dark: #E55722;
      --navigator-coral: #FF7961;
      --navigator-white: #ffffff;
      --navigator-black: #cfcfcf;
      --navigator-grey: #6b7280;
    }

    body {
      margin: 0;
      color: var(--navigator-black);
    }

    nav {
      background: var(--navigator-orange);
      margin-bottom: 2rem;

    }

    .nav-inner {
      display: flex;
      justify-content: space-between;
      padding: 0 1rem;
      width: 100%;
    }

    .navigator-logo {
      width: 10%;
      margin-right: 1rem;
      vertical-align: middle;
      border-radius: 4px;
      padding: 2px;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      color: var(--navigator-orange);
      background-color: var(--navigator-white);
      border: 1px solid var(--navigator-black);
      padding: 0.5rem;
      border-radius: 0.5rem;
    }

    table th {
      background: var(--navigator-orange);
      color: var(--navigator-white);
    }

    table tr:nth-child(even) {
      background-color: #f8f9fa;
    }

    .price-up {
      color: #b91c1c;
    }

    .price-down {
      color: var(--navigator-orange);
    }

    .muted {
      color: var(--navigator-grey);
    }

    a {
      color: var(--navigator-orange);
    }

    a:hover {
      color: var(--navigator-orange-dark);
    }

    .footer {
      margin-top: 0;
      padding: 2rem 0 1rem;
      border-top: 2px solid var(--navigator-orange);
      background: #2c2c2c;
      color: #fff;
      text-align: center;
      font-size: .9rem;
    }

    .footer a {
      color: var(--navigator-orange);
    }

    .footer a:hover {
      text-decoration: underline;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: .75rem 1.5rem;
      font-size: .875rem;
      font-weight: 500;
      line-height: 1.2;
      border: none;
      border-radius: .5rem;
      cursor: pointer;
      transition: all .2s;
      box-shadow: 0 1px 3px rgba(0, 0, 0, .1);
      position: relative;
      overflow: hidden;
    }

    .btn-primary {
      background: var(--navigator-orange);
      color: #fff;
      border: 1px solid var(--navigator-orange);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, var(--navigator-orange-dark), var(--navigator-orange));
      border-color: var(--navigator-orange-dark);
    }

    .btn-secondary {
      background: #fff;
      color: var(--navigator-orange);
      border: 1.5px solid var(--navigator-orange);
    }

    .btn-secondary:hover {
      background: var(--navigator-orange);
      color: #fff;
    }

    .nav-title {
      color: #fff !important;
      margin: auto;
      text-align: center;
      width: 100%;
      background-color: var(--navigator-orange) !important;
      border: 0px;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    .page-wrapper {
      min-height: 100vh;
      display: flex;
      flex-direction: column;

      /* Imagem de fundo */
      background-image: url('/static/background.jpg');
      /* substitui pelo caminho da tua imagem */
      background-size: cover;
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-position: center;
    }

    .content-wrapper {
      flex: 1;
      padding: 1rem 1rem 2rem;
      margin-bottom: 2rem;
      border-radius: 8px;
      /* destaca sobre o fundo */
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .container {
      padding: 0 1rem;
      border-radius: 4px;
    }

    table,
    table tr {
      background: #fff !important;
    }

    table tr:nth-child(even) {
      background: #f8f9fa !important;
    }
  </style>
</head>

<body>

  <div class="page-wrapper">
    <nav>
      <div class="nav-inner">
        <img src="/static/navigator-logo.png" alt="{% trans 'Navigator Logo' %}" class="navigator-logo">
        <h2 class="nav-title">NaviPrice.AI</h2>
        <!-- Language selector -->
        <select id="langToggle" style="
              width: auto;                /* adapta Ã  largura do texto */
              min-width: 120px;           /* evita encolher demasiado */
              background: var(--navigator-orange);
              color: #fff;
              margin: auto;
              font-size: 0.9rem;
              padding: 0.35rem 2rem 0.35rem 0.75rem;
              border: 1px solid var(--navigator-white);
              border-radius: 2rem;
              appearance: none;
              -webkit-appearance: none;
              -moz-appearance: none;
              background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2212%22 height=%228%22%3E%3Cpath fill=%22%23fff%22 d=%22M1 1l5 5 5-5%22/%3E%3C/svg%3E');
              background-repeat: no-repeat;
              background-position: right 0.75rem center;
              background-size: 12px 8px;
            ">
          <option value="pt" style="color:var(--navigator-white);">ðŸ‡µðŸ‡¹ PortuguÃªs</option>
          <option value="en" style="color:var(--navigator-white);">ðŸ‡¬ðŸ‡§ English</option>
        </select>

      </div>
    </nav>
    <div class="content-wrapper">


      {% if messages %}
      <div style="margin-bottom:1rem;">
        {% for message in messages %}
        <div style="padding:.75rem; margin-bottom:.5rem; border-radius:.375rem;
                      {% if message.tags == 'success' %}background:#d1fae5; color:#065f46; border:1px solid #a7f3d0;
                      {% elif message.tags == 'error' %}background:#fee2e2; color:#dc2626; border:1px solid #fca5a5;
                      {% elif message.tags == 'info' %}background:#dbeafe; color:#1d4ed8; border:1px solid #93c5fd;
                      {% else %}background:#f3f4f6; color:#374151; border:1px solid #d1d5db;{% endif %}">
          {{ message }}
        </div>
        {% endfor %}
      </div>
      {% endif %}

      {% block content %}{% endblock %}
    </div>
    <footer class="footer">
      {% trans "Prototype developed by" %} <strong>Mars Shot - Redefining Limits</strong> | <a
        href="https://www.marsshot.eu" target="_blank">www.marsshot.eu</a>
    </footer>
  </div>

  <!-- i18n toggle handler -->
  <script>
    function getCsrfToken() {
      const fromTpl = '{{ csrf_token }}';
      if (fromTpl && fromTpl !== 'NOTPROVIDED' && !/\{\{.+\}\}/.test(fromTpl)) return fromTpl;
      const m = document.cookie.match(/(?:^|;)\s*csrftoken=([^;]+)/);
      return m ? decodeURIComponent(m[1]) : '';
    }

    function computeNextForLang(newLang) {
      const url = new URL(window.location.href);
      const parts = url.pathname.split('/');
      if (['en', 'pt'].includes(parts[1])) {
        parts[1] = newLang;
      } else {
        parts.splice(1, 0, newLang);
      }
      url.pathname = parts.join('/').replace(/\/{2,}/g, '/');
      return url.pathname + url.search + url.hash;
    }

    document.addEventListener('DOMContentLoaded', function () {
      const langToggle = document.getElementById('langToggle');
      langToggle.value = window.serverLang;

      langToggle.addEventListener('change', function () {
        const newLang = this.value;
        const serverLang = window.serverLang;
        if (newLang === serverLang) return;

        localStorage.setItem('navigator-lang', newLang);
        window.currentLang = newLang;
        document.documentElement.setAttribute('lang', newLang);

        const form = document.createElement('form');
        form.method = 'POST';
        form.action = "{% url 'set_language' %}";

        const csrf = document.createElement('input');
        csrf.type = 'hidden'; csrf.name = 'csrfmiddlewaretoken'; csrf.value = getCsrfToken();

        const lang = document.createElement('input');
        lang.type = 'hidden'; lang.name = 'language'; lang.value = newLang;

        const next = document.createElement('input');
        next.type = 'hidden'; next.name = 'next'; next.value = computeNextForLang(newLang);

        form.appendChild(csrf);
        form.appendChild(lang);
        form.appendChild(next);

        if (window.rebuildChart) window.rebuildChart(newLang);

        document.body.appendChild(form);
        form.submit();
      });
    });
  </script>
</body>

</html>