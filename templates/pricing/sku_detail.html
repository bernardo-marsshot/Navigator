{% extends "base.html" %}
{% block content %}
<div style="background-color: var(--navigator-white); padding: 1rem; border-radius: 0.5rem; margin-bottom: 2rem;">
<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
  <div>
    <h2 style="margin: 0 0 0.5rem 0;">{{ sku.code }}</h2>
    <p style="margin: 0; color: var(--navigator-grey); font-size: 1.1rem;">{{ sku.name }}</p>
  </div>
  <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
    <a href="/" class="btn btn-ghost btn-sm">
      <span style="margin-right: 0.5rem;">‚Üê </span>
      Voltar
    </a>
    <button onclick="window.print()" class="btn btn-secondary btn-sm">
      <span style="margin-right: 0.5rem;">üñ®Ô∏è</span>
      Imprimir
    </button>
    <form method="post" action="/scrape-now/" style="display: inline; margin: 0;">
      {% csrf_token %}
      <button type="submit" class="btn btn-success btn-sm">
        <span style="margin-right: 0.5rem;">üîÑ</span>
        Atualizar dados
      </button>
    </form>
  </div>
</div>

<!-- wrapper com altura fixa -->
<div style="width:100%; height:300px; margin-bottom:2rem;">
  <canvas id="priceChart" style="width:100%; height:100%;"></canvas>
</div>

<script>
const ctx = document.getElementById('priceChart');

// Agrupar dados por retalhista
const retailerData = {};
const allLabels = new Set();

{% for p in price_points %}
const retailer_{{ forloop.counter }} = "{{ p.sku_listing.retailer.name }}";
const timestamp_{{ forloop.counter }} = "{{ p.timestamp|date:'Y-m-d H:i' }}";
const price_{{ forloop.counter }} = {{ p.promo_price|default:p.price|default:"null" }};

if (!retailerData[retailer_{{ forloop.counter }}]) {
  retailerData[retailer_{{ forloop.counter }}] = {};
}
retailerData[retailer_{{ forloop.counter }}][timestamp_{{ forloop.counter }}] = price_{{ forloop.counter }};
allLabels.add(timestamp_{{ forloop.counter }});
{% endfor %}

// Converter labels para array ordenado
const labels = Array.from(allLabels).sort();

// Cores para diferentes retalhistas
const colors = [
  '#FF6B35', // Navigator Orange
  '#FF8A65', // Navigator Orange Light
  '#4A90E2', // Blue
  '#50C878', // Green
  '#FFB347', // Orange
  '#DA70D6', // Orchid
  '#40E0D0', // Turquoise
  '#F0E68C'  // Khaki
];

// Criar datasets para cada retalhista
const datasets = [];
let colorIndex = 0;

for (const retailerName in retailerData) {
  const data = labels.map(label => retailerData[retailerName][label] || null);
  
  datasets.push({
    label: `${retailerName} (¬£)`,
    data: data,
    borderColor: colors[colorIndex % colors.length],
    backgroundColor: colors[colorIndex % colors.length] + '20', // 20% opacity
    fill: false,
    tension: 0.1,
    pointRadius: 4,
    pointHoverRadius: 6
  });
  
  colorIndex++;
}

new Chart(ctx, {
  type: 'line',
  data: {
    labels: labels,
    datasets: datasets
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      y: { 
        beginAtZero: false,
        title: {
          display: true,
          text: 'Pre√ßo (¬£)'
        }
      },
      x: {
        title: {
          display: true,
          text: 'Tempo'
        }
      }
    },
    plugins: {
      legend: {
        display: true,
        position: 'top'
      },
      title: {
        display: true,
        text: 'Evolu√ß√£o de Pre√ßos por Retalhista'
      }
    },
    interaction: {
      intersect: false,
      mode: 'index'
    }
  }
});
</script>

<h3>Hist√≥rico</h3>
<div style="background-color: var(--navigator-white); padding: 1rem; border-radius: 0.5rem; margin-bottom: 2rem;">
  <table style="background-color: var(--navigator-white) !important;">
    <thead>
      <tr>
        <th>Data</th>
        <th>Retalhista</th>
        <th>Pre√ßo</th>
        <th>Promo</th>
        <th>Nota</th>
      </tr>
    </thead>
    <tbody>
    {% for p in price_points %}
      <tr style="background-color: var(--navigator-white) !important;">
        <td>{{ p.timestamp }}</td>
        <td>{{ p.sku_listing.retailer.name }}</td>
        <td>{% if p.price %}{{ p.price }}{% else %}<span class="muted">‚Äî</span>{% endif %}</td>
        <td>{% if p.promo_price %}{{ p.promo_price }} ({{ p.promo_text }}){% else %}<span class="muted">‚Äî</span>{% endif %}</td>
        <td class="muted">{{ p.raw_snapshot|truncatechars:120 }}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>
</div>

{% endblock %}
