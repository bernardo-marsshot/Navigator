{% extends "base.html" %}
{% load i18n %}

{% block content %}
<style>
  /* Esconde bot√µes/a√ß√µes ao imprimir */
  @media print {
    .no-print { display: none !important; }
  }

  /* Ajustes de impress√£o (A4 portrait) */
  @media print {
    @page { size: A4 portrait; margin: 12mm; }

    /* No report, o wrapper n√£o for√ßa altura fixa */
    #chart-wrapper { height: auto !important; }

    /* Canvas ocupa largura, com altura controlada (mant√©m propor√ß√£o via JS) */
    #priceChart { width: 100% !important; max-height: 140mm !important; }

    /* Texto um pouco mais compacto na tabela */
    table { font-size: 12px; }
  }
</style>

<div style="background-color: var(--navigator-white); padding: 1rem; border-radius: 0.5rem; margin-bottom: 2rem;">

  <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
    <div>
      <h2 style="margin: 0 0 0.5rem 0;">{{ sku.name }}</h2>
      <p style="margin: 0; color: var(--navigator-grey); font-size: 1.1rem;">{{ sku.code }}</p>
    </div>

    <!-- A√ß√µes (escondidas no report) -->
    <div class="no-print" style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
      <a href="{% url 'home' %}"
         style="display:inline-flex; align-items:center; gap:0.5rem;
                padding:0.5rem 1rem; font-size:0.875rem; font-weight:500;
                color:var(--navigator-orange); border:1.5px solid var(--navigator-orange);
                border-radius:0.5rem; background:transparent; text-decoration:none;
                cursor:pointer; transition:all 0.2s ease-in-out;">
        <span>‚Üê</span>
        <span>{% trans "Back" %}</span>
      </a>

      <button onclick="window.print()" class="btn btn-secondary btn-sm">
        <span style="margin-right: 0.5rem;">üìÑ</span>
        {% trans "Report" %}
      </button>

<!-- Bot√£o de atualiza√ß√£o de dados 
      <form method="post" action="{% url 'scrape_now' %}" style="display: inline; margin: 0;">
        {% csrf_token %}
        <button type="submit" class="btn btn-success btn-sm" style="background-color: green; color: white;">
          <span style="margin-right: 0.5rem;">üîÑ</span>
          {% trans "Update Data" %}
        </button>
      </form> 
-->
    </div>
  </div>

  <!-- Gr√°fico -->
  <div id="chart-wrapper" style="width:100%; height:300px; margin-bottom:2rem;">
    <canvas id="priceChart" style="width:100%; height:100%;"></canvas>
  </div>

  <!-- Tradu√ß√µes JS -->
  <script>
    const translations = {
      price: '{% trans "Price" %}',
      time: '{% trans "Time" %}',
      priceEvolution: '{% trans "Price Evolution by Retailer" %}'
    };

    // Normaliza n√∫meros (pt -> v√≠rgula) para parsing JS
    function normalizeNumber(value, lang) {
      if (value === null || value === undefined || value === 'null') return null;
      let strValue = String(value);
      if (lang === 'pt' && strValue.includes(',')) strValue = strValue.replace(',', '.');
      const parsed = Number(strValue);
      return isNaN(parsed) ? null : parsed;
    }
  </script>

  <script>
    const ctx = document.getElementById('priceChart');
    let chartInstance = null; // guarda inst√¢ncia do Chart

    // Agrupar por retalhista
    const retailerData = {};
    const allLabels = new Set();

    {% for p in price_points %}
      const retailer_{{ forloop.counter }} = "{{ p.sku_listing.retailer.name }}";
      const timestamp_{{ forloop.counter }} = "{{ p.timestamp|date:'Y-m-d H:i' }}";
      const price_{{ forloop.counter }} = normalizeNumber("{{ p.promo_price|default:p.price|default:'null' }}", window.currentLang || 'pt');

      if (!retailerData[retailer_{{ forloop.counter }}]) {
        retailerData[retailer_{{ forloop.counter }}] = {};
      }
      retailerData[retailer_{{ forloop.counter }}][timestamp_{{ forloop.counter }}] = price_{{ forloop.counter }};
      allLabels.add(timestamp_{{ forloop.counter }});
    {% endfor %}

    // Labels ordenados (tempo)
    const labels = Array.from(allLabels).sort();

    // Paleta simples (podes trocar para as cores oficiais)
    const colors = [
      '#FF6B35', '#FF8A65', '#4A90E2', '#50C878',
      '#FFB347', '#DA70D6', '#40E0D0', '#F0E68C'
    ];

    // Constr√≥i datasets por retalhista
    const datasets = [];
    let colorIndex = 0;
    for (const retailerName in retailerData) {
      const data = labels.map(label => retailerData[retailerName][label] ?? null);
      const color = colors[colorIndex % colors.length];
      datasets.push({
        label: `${retailerName} (¬£)`,
        data: data,
        borderColor: color,
        backgroundColor: color + '20',
        fill: false,
        tension: 0.1,
        pointRadius: 4,
        pointHoverRadius: 6
      });
      colorIndex++;
    }

    function createChart() {
      if (chartInstance) { chartInstance.destroy(); chartInstance = null; }
      chartInstance = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,            // ecr√£: usa o wrapper (300px)
          scales: {
            y: {
              beginAtZero: false,
              title: { display: true, text: translations.price + ' (¬£)' }
            },
            x: {
              title: { display: true, text: translations.time }
            }
          },
          plugins: {
            legend: { display: true, position: 'top' },
            title: { display: true, text: translations.priceEvolution }
          },
          interaction: { intersect: false, mode: 'index' }
        }
      });
    }

    // Inicializa gr√°fico
    createChart();

    // Alterna op√ß√µes para impress√£o (evita achatamento)
    function setPrintAspectMode(isPrint) {
      if (!chartInstance) return;
      chartInstance.options.maintainAspectRatio = isPrint ? true : false; // print: preserva propor√ß√£o
      chartInstance.options.plugins.legend.position = isPrint ? 'bottom' : 'top';
      chartInstance.resize();
      chartInstance.update('none');
    }

    // Eventos de impress√£o (cross-browser)
    if (window.matchMedia) {
      try {
        const mq = window.matchMedia('print');
        if (mq && mq.addEventListener) {
          mq.addEventListener('change', e => setPrintAspectMode(e.matches));
        } else if (mq && mq.addListener) {
          mq.addListener(e => setPrintAspectMode(e.matches));
        }
      } catch (e) {}
    }
    window.addEventListener('beforeprint', () => setPrintAspectMode(true));
    window.addEventListener('afterprint',  () => setPrintAspectMode(false));

    // Suporte √† troca de linguagem vinda do base.html
    window.rebuildChart = function(newLang) {
      for (const rName in retailerData) {
        for (const ts in retailerData[rName]) {
          const originalValue = retailerData[rName][ts];
          if (originalValue !== null) {
            retailerData[rName][ts] = normalizeNumber(originalValue, newLang);
          }
        }
      }
      const newDatasets = [];
      let idx = 0;
      for (const rName in retailerData) {
        const data = labels.map(l => retailerData[rName][l] ?? null);
        const color = colors[idx % colors.length];
        newDatasets.push({
          label: `${rName} (¬£)`,
          data,
          borderColor: color,
          backgroundColor: color + '20',
          fill: false,
          tension: 0.1,
          pointRadius: 4,
          pointHoverRadius: 6
        });
        idx++;
      }
      datasets.length = 0;
      datasets.push(...newDatasets);
      createChart();
    };
  </script>

  <h3>{% trans "History" %}</h3>
  <div style="background-color: var(--navigator-white); padding: 1rem; border-radius: 0.5rem; margin-bottom: 2rem;">
    <table style="background-color: var(--navigator-white) !important; width: 100%;">
      <thead>
        <tr>
          <th>{% trans "Date" %}</th>
          <th>{% trans "Retailer" %}</th>
          <th>{% trans "Price" %}</th>
          <th>{% trans "Promo" %}</th>
          <th>{% trans "Note" %}</th>
        </tr>
      </thead>
      <tbody>
      {% for p in price_points %}
        <tr style="background-color: var(--navigator-white) !important;">
          <td>{{ p.timestamp }}</td>
          <td>{{ p.sku_listing.retailer.name }}</td>
          <td>{% if p.price %}{{ p.price }}{% else %}<span class="muted">{% trans "No data" %}</span>{% endif %}</td>
          <td>{% if p.promo_price %}{{ p.promo_price }} ({{ p.promo_text }}){% else %}<span class="muted">{% trans "No promo" %}</span>{% endif %}</td>
          <td class="muted">
            {% if p.raw_snapshot %}
              {% if 'search_url' in p.raw_snapshot %}
                <small>{% trans "Scraped from search" %}</small>
              {% elif 'timestamp' in p.raw_snapshot %}
                <small>{% trans "Auto-extracted" %}</small>
              {% else %}
                {{ p.raw_snapshot|truncatechars:60 }}
              {% endif %}
            {% else %}
              <small>{% trans "No debug info" %}</small>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

</div>
{% endblock %}
